@page "/chat"
@using Chatbot.Web.Services
@using Chatbot.Web.Models
@rendermode InteractiveServer
@inject IChatService ChatService
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Chat - Chatbot</PageTitle>

<div class="chat-container">
    <div class="chat-header">
        <h3>Chatbot</h3>
        <button class="btn btn-sm btn-outline-secondary" @onclick="HandleLogout">Logout</button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    @if (currentConversation == null)
    {
        <div class="start-conversation">
            <button class="btn btn-primary" @onclick="StartNewConversation">Start New Conversation</button>
        </div>
    }
    else
    {
        <div class="messages-container">
            @foreach (var message in messages)
            {
                <div class="message @(message.Sender == "User" ? "user-message" : "bot-message")">
                    <div class="message-header">
                        <strong>@message.Sender</strong>
                        <small>@message.SentAt.ToLocalTime().ToString("HH:mm")</small>
                    </div>
                    <div class="message-content">@message.Content</div>
                    @if (!string.IsNullOrEmpty(message.Sentiment))
                    {
                        <div class="message-meta">
                            <small>Sentiment: @message.Sentiment (@message.SentimentScore.ToString("F2"))</small>
                            @if (!string.IsNullOrEmpty(message.Intent))
                            {
                                <small> | Intent: @message.Intent</small>
                            }
                        </div>
                    }
                </div>
            }
            <div @ref="messagesEnd"></div>
        </div>

        <div class="input-container">
            <input type="text" 
                   class="form-control" 
                   placeholder="Type your message..." 
                   @bind="currentMessage" 
                   @onkeydown="HandleKeyDown"
                   disabled="@isSending" />
            <button class="btn btn-primary" @onclick="SendMessage" disabled="@isSending">
                @if (isSending)
                {
                    <span>Sending...</span>
                }
                else
                {
                    <span>Send</span>
                }
            </button>
        </div>
    }
</div>

@code {
    private ConversationResponse? currentConversation;
    private List<MessageDto> messages = new();
    private string currentMessage = "";
    private string? errorMessage;
    private bool isSending;
    private ElementReference messagesEnd;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated())
        {
            Navigation.NavigateTo("/login");
        }
    }

    private async Task StartNewConversation()
    {
        var (success, message, conversation) = await ChatService.StartConversationAsync("New Chat");
        
        if (success && conversation != null)
        {
            currentConversation = conversation;
            messages.Clear();
            errorMessage = null;
        }
        else
        {
            errorMessage = message;
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(currentMessage) || currentConversation == null)
            return;

        isSending = true;
        errorMessage = null;

        var userMessage = currentMessage;
        currentMessage = "";

        // Add user message to UI immediately
        messages.Add(new MessageDto(
            0, 
            userMessage, 
            "User", 
            DateTime.UtcNow, 
            "", 
            null, 
            0));

        var (success, message, response) = await ChatService.SendMessageAsync(currentConversation.Id, userMessage);

        if (success && response != null)
        {
            // Add bot response
            messages.Add(new MessageDto(
                0,
                response.Message,
                "Bot",
                response.Timestamp,
                response.Sentiment,
                response.Intent,
                response.SentimentScore));
        }
        else
        {
            errorMessage = message;
        }

        isSending = false;
        StateHasChanged();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isSending)
        {
            await SendMessage();
        }
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }
}

<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
        max-width: 800px;
        margin: 0 auto;
    }

    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #ddd;
    }

    .start-conversation {
        display: flex;
        justify-content: center;
        align-items: center;
        flex: 1;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        padding: 0.75rem;
        border-radius: 8px;
        max-width: 70%;
    }

    .user-message {
        align-self: flex-end;
        background-color: #007bff;
        color: white;
    }

    .bot-message {
        align-self: flex-start;
        background-color: #f1f3f4;
        color: #333;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .message-content {
        word-wrap: break-word;
    }

    .message-meta {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        opacity: 0.8;
    }

    .input-container {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
        border-top: 1px solid #ddd;
    }

    .input-container input {
        flex: 1;
    }

    .alert {
        margin: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 4px;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
</style>
