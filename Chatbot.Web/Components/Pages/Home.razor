@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]

<PageTitle>Home</PageTitle>

<div class="home-container">
    <h1>Welcome to Chatbot</h1>
    <p class="lead">Start a new conversation or continue an existing one below.</p>

    <div class="home-grid">
        <div class="home-section">
            <h3>New Conversation</h3>
            <p>Start a fresh conversation with the chatbot.</p>
            <input type="text" @bind="newConversationTitle" placeholder="Optional: Give your conversation a title" class="form-control mb-2" />
            <button class="btn btn-primary" @onclick="StartNewConversation" disabled="@IsLoading">
                @if (IsLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                Start Conversation
            </button>
        </div>

        <div class="home-section">
            <h3>Recent Conversations</h3>
            <ContentList 
                Items="conversations" 
                IsLoading="IsLoadingConversations"
                ErrorMessage="conversationError"
                EmptyMessage="No conversations yet. Start one to get began!"
                OnItemSelected="SelectConversation" />
        </div>

        <div class="home-section">
            <h3>Quick Stats</h3>
            @if (IsLoadingAnalytics)
            {
                <p><span class="spinner-border spinner-border-sm me-2"></span>Loading analytics...</p>
            }
            else if (analytics != null)
            {
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value">@analytics.TotalConversations</span>
                        <span class="stat-label">Total Conversations</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">@analytics.TotalMessages</span>
                        <span class="stat-label">Total Messages</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">@analytics.AverageSentiment.ToString("F2")</span>
                        <span class="stat-label">Avg Sentiment</span>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(analyticsError))
            {
                <p class="text-danger">@analyticsError</p>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <Alert Message="@errorMessage" Type="Alert.AlertType.Error" />
    }
</div>

<style>
.home-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.home-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.home-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.home-section h3 {
    margin-top: 0;
    color: #333;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 15px;
}

.stat-item {
    background: white;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
    border: 1px solid #dee2e6;
}

.stat-value {
    display: block;
    font-size: 24px;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 5px;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
}
</style>

@code {
    [Inject]
    private IChatService ChatService { get; set; } = null!;

    [Inject]
    private IConversationService ConversationService { get; set; } = null!;

    [Inject]
    private IAnalyticsService AnalyticsService { get; set; } = null!;

    [Inject]
    private NavigationManager Navigation { get; set; } = null!;

    private List<ConversationResponse> conversations = new();
    private ConversationAnalytics? analytics;
    private string newConversationTitle = "";
    private string? errorMessage;
    private string? conversationError;
    private string? analyticsError;
    private bool IsLoading;
    private bool IsLoadingConversations;
    private bool IsLoadingAnalytics;

    protected override async Task OnInitializedAsync()
    {
        await LoadConversations();
        await LoadAnalytics();
    }

    private async Task LoadConversations()
    {
        IsLoadingConversations = true;
        conversationError = null;
        try
        {
            var (success, message, convos) = await ConversationService.GetConversationsAsync();
            if (success && convos != null)
            {
                conversations = convos.OrderByDescending(c => c.StartedAt).ToList();
            }
            else
            {
                conversationError = message;
            }
        }
        catch (Exception ex)
        {
            conversationError = $"Error loading conversations: {ex.Message}";
        }
        finally
        {
            IsLoadingConversations = false;
        }
    }

    private async Task LoadAnalytics()
    {
        IsLoadingAnalytics = true;
        analyticsError = null;
        try
        {
            var (success, message, data) = await AnalyticsService.GetAnalyticsAsync();
            if (success && data != null)
            {
                analytics = data;
            }
            else
            {
                analyticsError = message;
            }
        }
        catch (Exception ex)
        {
            analyticsError = $"Error loading analytics: {ex.Message}";
        }
        finally
        {
            IsLoadingAnalytics = false;
        }
    }

    private async Task StartNewConversation()
    {
        IsLoading = true;
        errorMessage = null;
        try
        {
            var (success, message, conversation) = await ChatService.StartConversationAsync(newConversationTitle);
            if (success && conversation != null)
            {
                Navigation.NavigateTo($"/chat/{conversation.Id}");
            }
            else
            {
                errorMessage = message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error starting conversation: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void SelectConversation(ConversationResponse conversation)
    {
        Navigation.NavigateTo($"/chat/{conversation.Id}");
    }
}

